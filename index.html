<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vorta Fitness - Club Management</title>
    
    <!-- External Libraries (Bootstrap & Font Awesome) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Google Fonts (Poppins & Tahoma for Arabic) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Tahoma:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- INTERNAL CSS -->
    <style>
        :root {
            --dark-bg: #1a1c23;
            --dark-surface: #252831;
            --primary-color: #0d6efd;
            --success-color: #198754;
            --danger-color: #dc3545;
            --text-light: #f8f9fa;
            --text-muted: #8a92a6;
            --border-color: #3b3e47;
            --body-font: 'Poppins', sans-serif;
        }

        body {
            font-family: var(--body-font);
            background-color: var(--dark-bg);
            color: var(--text-light);
            margin: 0;
            font-size: 0.9rem;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- LOGIN STYLES START --- */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .login-box {
            width: 100%;
            max-width: 400px;
            background-color: var(--dark-surface);
            padding: 2.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .login-box .form-control {
            padding: 0.75rem 1rem;
            height: 50px;
        }
        .login-box .btn {
            padding: 0.75rem 1rem;
            font-weight: 600;
        }
        .login-header {
             display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
        }
        .login-header .fa-dumbbell { color: var(--primary-color); }
        .login-header h1 { letter-spacing: 0.5px; font-weight: 600; font-size: 1.5rem; }
        #login-error-msg {
            display: none;
            font-size: 0.85rem;
        }
        /* --- LOGIN STYLES END --- */


        .main-container { display: flex; min-height: 100vh; }
        .main-container.d-none { display: none !important; } /* To hide the main app before login */

        .content-wrapper { flex-grow: 1; display: flex; flex-direction: column; }

        .main-sidebar {
            width: 260px;
            background-color: var(--dark-surface);
            flex-shrink: 0;
            border-right: 1px solid var(--border-color);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem 1rem;
            color: var(--text-light);
            border-bottom: 1px solid var(--border-color);
        }
        .sidebar-header .fa-dumbbell { color: var(--primary-color); }
        .sidebar-header h1 { letter-spacing: 0.5px; font-weight: 600; }

        .main-sidebar .list-group-item {
            background: transparent; color: var(--text-muted); border: none; padding: 1.1rem 1.5rem;
            font-weight: 500; transition: all 0.2s ease-in-out; border-left: 4px solid transparent;
        }
        .main-sidebar .list-group-item:hover { background-color: var(--dark-bg); color: var(--text-light); }
        .main-sidebar .list-group-item.active { background-color: var(--dark-bg); color: var(--text-light); border-left-color: var(--primary-color); font-weight: 600; }
        
        .navbar { background-color: var(--dark-surface); border-bottom: 1px solid var(--border-color); padding: 0.75rem 1rem; }
        main.container-fluid { padding: 2rem; }
        
        h2.mb-4 { font-weight: 600; color: #e9ecef; }
        h5.card-title { font-weight: 600; }
        p.text-muted { font-size: 0.85rem; }

        .btn { font-weight: 500; }
        .btn-group-lang .btn { color: var(--text-muted); border-color: var(--border-color); }
        .btn-group-lang .btn.active, .btn-group-lang .btn:hover { background-color: var(--primary-color); color: var(--text-light); border-color: var(--primary-color); }

        .card { background-color: var(--dark-surface); border: 1px solid var(--border-color); border-radius: 0.5rem; }
        .stat-card { background-color: var(--dark-surface); border-radius: 8px; padding: 1.5rem; display: flex; align-items: center; gap: 1.25rem; border: 1px solid var(--border-color); }
        .stat-card .card-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; color: #fff; flex-shrink: 0;}
        .stat-card .card-title { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.1rem; }
        .stat-card .card-value { font-size: 1.8rem; font-weight: 600; color: var(--text-light); margin: 0; line-height: 1.2; }
        
        .clickable-card {
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .clickable-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .chart-container { background-color: var(--dark-surface); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color); }
        .table { background-color: transparent; color: var(--text-light); }
        .table thead th { color: var(--text-muted); border-bottom: 2px solid var(--border-color); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; padding-top: 1rem; padding-bottom: 1rem;}
        .table td, .table th { border-bottom: 1px solid var(--border-color); vertical-align: middle; padding: 0.9rem 0.75rem; }
        .table tbody tr:last-child td { border-bottom: none; }
        .table-hover tbody tr:hover { background-color: var(--dark-bg); }

        .modal-content { background-color: var(--dark-surface); color: var(--text-light); border: 1px solid var(--border-color); border-radius: 0.5rem;}
        .modal-header, .modal-footer { border-color: var(--border-color); }
        .modal-header { padding: 1rem 1.5rem; } .modal-body { padding: 1.5rem; } .modal-footer { padding: 1rem 1.5rem; }
        .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        .form-label { margin-bottom: 0.5rem; font-weight: 500; color: var(--text-muted); font-size: 0.85rem;}
        .form-control, .form-select { background-color: var(--dark-bg); color: var(--text-light); border: 1px solid var(--border-color); padding: 0.6rem 1rem; }
        .form-control:focus, .form-select:focus { background-color: var(--dark-bg); color: var(--text-light); border-color: var(--primary-color); box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .form-control:read-only { background-color: #313541; }
        .input-group-text { background-color: var(--dark-bg); border-color: var(--border-color); color: var(--text-muted); }
        .dropdown-menu { background-color: var(--dark-surface); border-color: var(--border-color); }
        .dropdown-item { color: var(--text-light); } .dropdown-item:hover { background-color: var(--primary-color); }

        [dir="rtl"] { font-family: 'Tahoma', sans-serif; }
        [dir="rtl"] .main-sidebar { border-right: none; border-left: 1px solid var(--border-color); }
        [dir="rtl"] .main-sidebar .list-group-item.active { border-left: none; border-right: 4px solid var(--primary-color); }
        [dir="rtl"] .me-2 { margin-right: 0 !important; margin-left: .5rem !important; }
        [dir="rtl"] .me-3 { margin-right: 0 !important; margin-left: 1rem !important; }
        [dir="rtl"] .ms-auto { margin-right: auto !important; margin-left: 0 !important; }
        [dir="rtl"] .text-end { text-align: left !important; }
        [dir="rtl"] .text-start { text-align: right !important; }
    </style>
</head>
<body>
    <!-- ======================= LOGIN SCREEN ======================= -->
    <div id="login-screen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <i class="fas fa-dumbbell fa-2x me-3"></i>
                <h1 class="h3 mb-0">Vorta Fitness</h1>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="password" class="form-label" data-translate="password">Password</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <div class="alert alert-danger" id="login-error-msg" data-translate="alertIncorrectPassword">
                    Incorrect password.
                </div>
                <button type="submit" class="btn btn-primary w-100" data-translate="login">Login</button>
            </form>
        </div>
    </div>


    <!-- ======================= MAIN APP CONTAINER (hidden by default) ======================= -->
    <div class="main-container d-none">
        <!-- ======================= SIDEBAR ======================= -->
        <aside class="main-sidebar">
            <div class="sidebar-header">
                <i class="fas fa-dumbbell fa-lg me-2"></i>
                <h1 class="h5 mb-0">Vorta Fitness</h1>
            </div>
            <ul class="list-group list-group-flush">
                <a href="#" class="list-group-item list-group-item-action active" data-tab="dashboard"><i class="fas fa-chart-pie fa-fw me-3"></i><span data-translate="dashboard">Dashboard</span></a>
                <a href="#" class="list-group-item list-group-item-action" data-tab="members"><i class="fas fa-users fa-fw me-3"></i><span data-translate="members">Members</span></a>
                <a href="#" class="list-group-item list-group-item-action" data-tab="financials"><i class="fas fa-wallet fa-fw me-3"></i><span data-translate="financials">Financials</span></a>
                <a href="#" class="list-group-item list-group-item-action" data-tab="subscriptions"><i class="fas fa-tags fa-fw me-3"></i><span data-translate="subscriptions">Subscriptions</span></a>
                <a href="#" class="list-group-item list-group-item-action" data-tab="messaging"><i class="fas fa-comments fa-fw me-3"></i><span data-translate="messaging">Messaging</span></a>
                <a href="#" class="list-group-item list-group-item-action" data-tab="reports"><i class="fas fa-chart-line fa-fw me-3"></i><span data-translate="reports">Reports</span></a>
                <a href="#" class="list-group-item list-group-item-action" data-tab="settings"><i class="fas fa-cog fa-fw me-3"></i><span data-translate="settings">Settings</span></a>
            </ul>
        </aside>

        <!-- ======================= CONTENT WRAPPER ======================= -->
        <div class="content-wrapper">
            <nav class="navbar"><div class="container-fluid"><div class="ms-auto btn-group btn-group-sm btn-group-lang"><button type="button" class="btn btn-outline-secondary" data-lang="english">English</button><button type="button" class="btn btn-outline-secondary" data-lang="arabic">العربية</button></div></div></nav>
            <main class="container-fluid">
                <!-- DASHBOARD TAB -->
                <div id="dashboard-tab" class="content-tab">
                    <h2 class="mb-4" data-translate="dashboard">Dashboard</h2>
                    <!-- Member Stats -->
                    <div class="row g-4">
                        <div class="col-xl-3 col-md-6"><div class="stat-card clickable-card" data-filter="all"><div class="card-icon bg-primary"><i class="fas fa-users"></i></div><div class="card-details"><h6 class="card-title" data-translate="totalMembers">Total Members</h6><p class="card-value" id="total-members">0</p></div></div></div>
                        <div class="col-xl-3 col-md-6"><div class="stat-card clickable-card" data-filter="active"><div class="card-icon bg-success"><i class="fas fa-check-circle"></i></div><div class="card-details"><h6 class="card-title" data-translate="activeSubscriptions">Active Subscriptions</h6><p class="card-value" id="active-subscriptions">0</p></div></div></div>
                        <div class="col-xl-3 col-md-6"><div class="stat-card clickable-card" data-filter="expiring"><div class="card-icon bg-warning"><i class="fas fa-exclamation-triangle"></i></div><div class="card-details"><h6 class="card-title" data-translate="expiringSoon">Expiring Soon</h6><p class="card-value" id="expiring-subscriptions">0</p></div></div></div>
                        <div class="col-xl-3 col-md-6"><div class="stat-card clickable-card" data-filter="unsubscribed"><div class="card-icon bg-danger"><i class="fas fa-times-circle"></i></div><div class="card-details"><h6 class="card-title" data-translate="unsubscribed">Unsubscribed</h6><p class="card-value" id="unsubscribed-members">0</p></div></div></div>
                    </div>
                     <!-- Financial Stats -->
                    <h3 class="my-4" data-translate="financialSummary">Financial Summary</h3>
                    <div class="row g-4">
                        <div class="col-xl-4 col-md-6"><div class="stat-card"><div class="card-icon" style="background-color: var(--success-color);"><i class="fas fa-arrow-up"></i></div><div class="card-details"><h6 class="card-title" data-translate="totalIncome">Total Income</h6><p class="card-value" id="total-income">₪0</p></div></div></div>
                        <div class="col-xl-4 col-md-6"><div class="stat-card"><div class="card-icon" style="background-color: var(--danger-color);"><i class="fas fa-arrow-down"></i></div><div class="card-details"><h6 class="card-title" data-translate="totalExpenses">Total Expenses</h6><p class="card-value" id="total-expenses">₪0</p></div></div></div>
                        <div class="col-xl-4 col-md-12"><div class="stat-card"><div class="card-icon" style="background-color: var(--primary-color);"><i class="fas fa-balance-scale"></i></div><div class="card-details"><h6 class="card-title" data-translate="netProfit">Net Profit</h6><p class="card-value" id="net-profit">₪0</p></div></div></div>
                    </div>
                    <!-- Charts -->
                    <div class="row g-4 mt-4">
                        <div class="col-lg-7"><div class="chart-container"><canvas id="subscriptionTypeChart"></canvas></div></div>
                        <div class="col-lg-5"><div class="chart-container"><canvas id="genderDistributionChart"></canvas></div></div>
                    </div>
                </div>
                <!-- MEMBERS TAB -->
                <div id="members-tab" class="content-tab d-none"><div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3"><h2 class="mb-0" data-translate="members">Members</h2><div class="d-flex align-items-center gap-2"><div class="input-group"><span class="input-group-text"><i class="fas fa-search"></i></span><input type="search" id="member-search" class="form-control" placeholder="Search..." data-translate="search"></div><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMemberModal"><i class="fas fa-plus me-2"></i><span data-translate="addMember">Add Member</span></button></div></div><div class="btn-group btn-group-sm mb-3" role="group"><button type="button" class="btn btn-outline-secondary active" onclick="filterMembersByGender('all')" data-gender="all" data-translate="all">All</button><button type="button" class="btn btn-outline-secondary" onclick="filterMembersByGender('male')" data-gender="male" data-translate="male">Male</button><button type="button" class="btn btn-outline-secondary" onclick="filterMembersByGender('female')" data-gender="female" data-translate="female">Female</button></div><div class="table-responsive"><table class="table table-hover" id="members-table"><thead><tr><th data-translate="memberId">ID</th><th data-translate="fullName">Full Name</th><th data-translate="gender">Gender</th><th data-translate="contact">Contact</th><th data-translate="subscription">Subscription</th><th data-translate="status">Status</th><th data-translate="actions">Actions</th></tr></thead><tbody></tbody></table></div></div>
                
                <!-- FINANCIALS TAB -->
                <div id="financials-tab" class="content-tab d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                        <h2 class="mb-0" data-translate="financials">Financials</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTransactionModal" onclick="prepareAddTransactionModal()"><i class="fas fa-plus me-2"></i><span data-translate="addTransaction">Add Transaction</span></button>
                    </div>
                    <div class="card bg-surface">
                        <div class="card-body">
                           <div class="table-responsive">
                               <table class="table table-hover" id="financials-table">
                                   <thead><tr>
                                       <th data-translate="date">Date</th>
                                       <th data-translate="description">Description</th>
                                       <th data-translate="type">Type</th>
                                       <th class="text-end" data-translate="amount">Amount</th>
                                       <th class="text-end" data-translate="actions">Actions</th>
                                   </tr></thead>
                                   <tbody></tbody>
                               </table>
                           </div>
                        </div>
                    </div>
                </div>

                <!-- SUBSCRIPTIONS TAB -->
                <div id="subscriptions-tab" class="content-tab d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                        <h2 class="mb-0" data-translate="subscriptionManagement">Subscription Management</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#subscriptionTypeModal" onclick="prepareSubscriptionTypeModal(null)"><i class="fas fa-plus me-2"></i><span data-translate="addSubType">Add Subscription Type</span></button>
                    </div>
                    <div class="card bg-surface">
                        <div class="card-body">
                           <div class="table-responsive">
                               <table class="table table-hover" id="subscription-types-table">
                                   <thead><tr>
                                       <th data-translate="subName">Name</th>
                                       <th data-translate="durationInDays">Duration (Days)</th>
                                       <th data-translate="price">Price</th>
                                       <th data-translate="actions">Actions</th>
                                   </tr></thead>
                                   <tbody></tbody>
                               </table>
                           </div>
                        </div>
                    </div>
                </div>

                <!-- MESSAGING TAB -->
                <div id="messaging-tab" class="content-tab d-none"><h2 class="mb-4" data-translate="messaging">Messaging</h2><div class="row g-4"><div class="col-lg-5"><div class="card bg-surface h-100"><div class="card-body d-flex flex-column"><h5 class="card-title mb-4" data-translate="sendNewMessage">Send New Message</h5><form id="message-form"><div class="mb-3"><label for="message-recipients" class="form-label" data-translate="recipients">Recipients</label><select id="message-recipients" class="form-select" data-translate-options="recipientsOptions"></select></div><div class="mb-3 d-none" id="individual-select-container"><label for="individual-member" class="form-label" data-translate="selectMember">Select Member</label><select id="individual-member" class="form-select"></select></div><div class="mb-3"><label for="message-content" class="form-label" data-translate="message">Message</label><textarea id="message-content" class="form-control" rows="6" placeholder="Type your message..." data-translate="messagePlaceholder"></textarea></div><button type="submit" class="btn btn-primary w-100 mt-auto"><i class="fas fa-paper-plane me-2"></i><span data-translate="sendMessage">Send Message</span></button></form></div></div></div><div class="col-lg-7"><div class="card bg-surface h-100"><div class="card-body"><h5 class="card-title mb-4" data-translate="messageHistory">Message History</h5><div class="table-responsive" style="max-height: 500px;"><table class="table" id="message-history-table"><thead data-translate-headers="messageHistoryHeaders"><tr><th>Date</th><th>Recipients</th><th>Message</th><th>Status</th></tr></thead><tbody></tbody></table></div></div></div></div></div></div>
                <!-- REPORTS TAB -->
                <div id="reports-tab" class="content-tab d-none"><h2 class="mb-4" data-translate="advancedReports">Advanced Reports</h2><div class="row g-4"><div class="col-12"><div class="card bg-surface"><div class="card-body"><h5 class="card-title" data-translate="memberGrowth">Member Growth</h5><p class="text-muted small" data-translate="memberGrowthDesc">Shows members joined each month.</p><div class="chart-container" style="height: 350px;"><canvas id="memberGrowthChart"></canvas></div></div></div></div><div class="col-12"><div class="card bg-surface"><div class="card-body"><h5 class="card-title" data-translate="subscriptionsReport">Subscriptions Report</h5><p class="text-muted small" data-translate="subscriptionsReportDesc">Detailed subscription data.</p><div class="table-responsive"><table class="table" id="subscriptions-report-table"><thead data-translate-headers="subscriptionsReportHeaders"><tr><th>Member Name</th><th>Sub. Type</th><th>Start Date</th><th>End Date</th><th>Status</th></tr></thead><tbody></tbody></table></div></div></div></div></div></div>
                
                <!-- SETTINGS TAB (NEW DYNAMIC VERSION) -->
                <div id="settings-tab" class="content-tab d-none">
                    <h2 class="mb-4" data-translate="settings">Settings</h2>
                    <div class="row g-4" id="settings-cards-container">
                        <!-- Cards are injected here by JS -->
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="addMemberModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" data-translate="addMemberTitle">Add New Member</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="add-member-form" novalidate>
                        <div class="row g-3">
                            <div class="col-md-6"><label for="add-first-name" class="form-label" data-translate="firstName">First Name</label><input type="text" class="form-control" id="add-first-name" required></div>
                            <div class="col-md-6"><label for="add-last-name" class="form-label" data-translate="lastName">Last Name</label><input type="text" class="form-control" id="add-last-name" required></div>
                            <div class="col-md-6"><label for="add-phone" class="form-label" data-translate="phone">Phone</label><input type="tel" class="form-control" id="add-phone" required></div>
                            <div class="col-md-6"><label for="add-email" class="form-label" data-translate="emailOptional">Email (Optional)</label><input type="email" class="form-control" id="add-email"></div>
                            <div class="col-md-6"><label for="add-gender" class="form-label" data-translate="gender">Gender</label><select id="add-gender" class="form-select" data-translate-options="genderOptions"></select></div>
                            <div class="col-md-6"><label for="add-language" class="form-label" data-translate="prefLanguage">Preferred Language</label><select id="add-language" class="form-select" data-translate-options="languageOptions"></select></div>
                            <hr class="my-3">
                            <div class="col-md-6"><label for="add-member-subscription-type" class="form-label" data-translate="subscription">Subscription</label><select id="add-member-subscription-type" class="form-select"></select></div>
                            <div class="col-md-6"><label for="add-member-subscription-price" class="form-label" data-translate="price">Price</label><div class="input-group"><span class="input-group-text">₪</span><input type="number" class="form-control" id="add-member-subscription-price" readonly></div></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="cancel">Cancel</button><button type="submit" form="add-member-form" class="btn btn-primary" data-translate="addMember">Add Member</button></div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="editMemberModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" data-translate="editMemberTitle">Edit Member</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="edit-member-form"><input type="hidden" id="edit-member-id"><div class="row g-3"><div class="col-md-6"><label class="form-label" data-translate="firstName">First Name</label><input type="text" class="form-control" id="edit-first-name" required></div><div class="col-md-6"><label class="form-label" data-translate="lastName">Last Name</label><input type="text" class="form-control" id="edit-last-name" required></div><div class="col-md-6"><label class="form-label" data-translate="phone">Phone</label><input type="tel" class="form-control" id="edit-phone" required></div><div class="col-md-6"><label class="form-label" data-translate="email">Email</label><input type="email" class="form-control" id="edit-email"></div><div class="col-md-6"><label class="form-label" data-translate="gender">Gender</label><select id="edit-gender" class="form-select" data-translate-options="genderOptions"></select></div><div class="col-md-6"><label class="form-label" data-translate="prefLanguage">Preferred Language</label><select id="edit-language" class="form-select" data-translate-options="languageOptions"></select></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="cancel">Cancel</button><button type="submit" form="edit-member-form" class="btn btn-primary" data-translate="saveChanges">Save Changes</button></div></div></div></div>
    <div class="modal fade" id="viewMemberModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" data-translate="memberDetailsTitle">Member Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="viewMemberModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="close">Close</button></div></div></div></div>
    <div class="modal fade" id="subscriptionModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="subscriptionModalLabel" data-translate="addRenewSubTitle">Add/Renew Subscription</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="subscription-form"><input type="hidden" id="subscription-member-id"><p><span data-translate="member">Member</span>: <strong id="subscription-member-name"></strong></p><div class="mb-3"><label for="subscription-modal-type" class="form-label" data-translate="subType">Type</label><select id="subscription-modal-type" class="form-select"></select></div><div class="mb-3"><label for="subscription-start-date" class="form-label" data-translate="startDate">Start Date</label><input type="date" class="form-control" id="subscription-start-date" required></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="cancel">Cancel</button><button type="submit" form="subscription-form" class="btn btn-primary" data-translate="save">Save</button></div></div></div></div>
    
    <!-- Subscription Type Modal -->
    <div class="modal fade" id="subscriptionTypeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="subscriptionTypeModalLabel" data-translate="addSubType">Add Subscription Type</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="subscription-type-form">
                        <input type="hidden" id="sub-type-id">
                        <div class="mb-3"><label for="sub-type-name-en" class="form-label">Name (English)</label><input type="text" class="form-control" id="sub-type-name-en" required></div>
                        <div class="mb-3"><label for="sub-type-name-ar" class="form-label">Name (Arabic)</label><input type="text" class="form-control" id="sub-type-name-ar" dir="rtl" required></div>
                        <div class="mb-3"><label for="sub-type-duration" class="form-label" data-translate="durationInDays">Duration (Days)</label><input type="number" class="form-control" id="sub-type-duration" required min="1"></div>
                        <div class="mb-3"><label for="sub-type-price" class="form-label" data-translate="price">Price</label><div class="input-group"><span class="input-group-text">₪</span><input type="number" class="form-control" id="sub-type-price" required min="0"></div></div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="cancel">Cancel</button><button type="submit" form="subscription-type-form" class="btn btn-primary" data-translate="save">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Transaction Modal (for Add/Edit) -->
    <div class="modal fade" id="addTransactionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="transactionModalLabel" data-translate="addTransaction">Add Transaction</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="add-transaction-form">
                        <input type="hidden" id="transaction-id">
                        <div class="mb-3"><label for="transaction-type" class="form-label" data-translate="type">Type</label><select id="transaction-type" class="form-select" data-translate-options="transactionTypeOptions"></select></div>
                        <div class="mb-3"><label for="transaction-description" class="form-label" data-translate="description">Description</label><input type="text" class="form-control" id="transaction-description" required></div>
                        <div class="mb-3"><label for="transaction-amount" class="form-label" data-translate="amount">Amount</label><div class="input-group"><span class="input-group-text">₪</span><input type="number" class="form-control" id="transaction-amount" required min="0" step="0.01"></div></div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="cancel">Cancel</button><button type="submit" form="add-transaction-form" class="btn btn-primary" data-translate="save">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Financials Password Modal (NEW) -->
    <div class="modal fade" id="financialsPasswordModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" data-translate="financials">Financials</h5>
                </div>
                <div class="modal-body">
                    <p class="text-muted" data-translate="financialsPasswordDesc">Please enter the password to view financial data.</p>
                    <form id="financials-password-form">
                        <div class="mb-3">
                            <label for="financials-password-input" class="form-label" data-translate="password">Password</label>
                            <input type="password" class="form-control" id="financials-password-input" required>
                        </div>
                        <div class="alert alert-danger d-none" id="financials-password-error" data-translate="alertIncorrectPassword">
                            Incorrect password.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="showTab('dashboard')" data-bs-dismiss="modal" data-translate="cancel">Cancel</button>
                    <button type="submit" form="financials-password-form" class="btn btn-primary" data-translate="login">Login</button>
                </div>
            </div>
        </div>
    </div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // =================================================================================
    // Vorta Fitness - Club Management System
    // Version: 11.0 (Merged & Fixed)
    // =================================================================================
    'use strict';

    // --- Configuration ---
    const SHEETDB_API_URL = 'https://sheetdb.io/api/v1/7dseleml89pqu'; 
    const SHEETS = {
        members: 'Members',
        transactions: 'Transactions',
        subscriptionTypes: 'SubscriptionTypes',
        messageHistory: 'MessageHistory',
        passwords: 'Passwords' // New sheet for passwords
    };
    const EXPIRATION_REMINDER_DAYS = 10;
    
    // --- Global State ---
    let currentTab = 'dashboard', currentLanguage = localStorage.getItem('vortaFitnessLanguage') || 'english';
    let members = [], messageHistory = [], subscriptionTypes = [], transactions = [];
    let passwords = {}; // Object to hold system and financials passwords
    let genderChart, subscriptionChart, memberGrowthChart = null;
    let dashboardFilter = null; 

    // --- Translations (Merged) ---
    const translations = {
        dashboard: { english: 'Dashboard', arabic: 'لوحة التحكم' }, members: { english: 'Members', arabic: 'الأعضاء' }, financials: { english: 'Financials', arabic: 'المالية' }, subscriptions: { english: 'Subscriptions', arabic: 'الاشتراكات' }, messaging: { english: 'Messaging', arabic: 'الرسائل' }, reports: { english: 'Reports', arabic: 'التقارير' }, settings: { english: 'Settings', arabic: 'الإعدادات' },
        totalMembers: { english: 'Total Members', arabic: 'إجمالي الأعضاء' }, activeSubscriptions: { english: 'Active Subscriptions', arabic: 'الاشتراكات النشطة' }, expiringSoon: { english: 'Expiring Soon', arabic: 'تنتهي قريباً' }, unsubscribed: { english: 'Unsubscribed', arabic: 'غير مشتركين' },
        financialSummary: { english: 'Financial Summary', arabic: 'الملخص المالي' }, totalIncome: { english: 'Total Income', arabic: 'إجمالي الإيرادات' }, totalExpenses: { english: 'Total Expenses', arabic: 'إجمالي المصروفات' }, netProfit: { english: 'Net Profit', arabic: 'صافي الربح' },
        memberId: { english: 'ID', arabic: 'الرقم' }, fullName: { english: 'Full Name', arabic: 'الاسم الكامل' }, gender: { english: 'Gender', arabic: 'الجنس' }, contact: { english: 'Contact', arabic: 'التواصل' }, subscription: { english: 'Subscription', arabic: 'الاشتراك' }, status: { english: 'Status', arabic: 'الحالة' }, actions: { english: 'Actions', arabic: 'الإجراءات' },
        addMember: { english: 'Add Member', arabic: 'إضافة عضو' }, search: { english: 'Search...', arabic: 'بحث...' }, all: { english: 'All', arabic: 'الكل' }, male: { english: 'Male', arabic: 'ذكور' }, female: { english: 'Female', arabic: 'إناث' },
        save: { english: 'Save', arabic: 'حفظ' }, saveData: { english: 'Save Data', arabic: 'حفظ البيانات' }, saveChanges: { english: 'Save Changes', arabic: 'حفظ التغييرات' }, cancel: { english: 'Cancel', arabic: 'إلغاء' }, close: { english: 'Close', arabic: 'إغلاق' }, view: { english: 'View', arabic: 'عرض' }, edit: { english: 'Edit', arabic: 'تعديل' }, delete: { english: 'Delete', arabic: 'حذف' }, renewSub: { english: 'Renew Sub', arabic: 'تجديد اشتراك' },
        sendNewMessage: { english: 'Send New Message', arabic: 'إرسال رسالة جديدة' }, recipients: { english: 'Recipients', arabic: 'المستلمون' }, selectMember: { english: 'Select Member', arabic: 'اختر عضو' }, message: { english: 'Message', arabic: 'الرسالة' }, messagePlaceholder: { english: 'Type your message...', arabic: 'اكتب رسالتك...' }, sendMessage: { english: 'Send Message', arabic: 'إرسال الرسالة' }, messageHistory: { english: 'Message History', arabic: 'سجل الرسائل' },
        advancedReports: { english: 'Advanced Reports', arabic: 'تقارير متقدمة' }, memberGrowth: { english: 'Member Growth', arabic: 'نمو الأعضاء' }, memberGrowthDesc: { english: 'Shows members joined each month.', arabic: 'يعرض الأعضاء المنضمين كل شهر.'},
        subscriptionsReport: { english: 'Subscriptions Report', arabic: 'تقرير الاشتراكات' }, subscriptionsReportDesc: { english: 'Detailed subscription data.', arabic: 'بيانات الاشتراكات المفصلة.'},
        changePassword: { english: 'Change System Password', arabic: 'تغيير كلمة مرور النظام'}, changePasswordDesc: { english: 'Update the system access password.', arabic: 'تحديث كلمة مرور الدخول للنظام.'},
        changeFinancialsPassword: { english: 'Change Financials Password', arabic: 'تغيير كلمة مرور المالية' }, changeFinancialsPasswordDesc: { english: 'Update the password for the financials tab.', arabic: 'تحديث كلمة المرور الخاصة بصفحة المالية.'},
        financialsPasswordDesc: { english: 'Please enter the password to view financial data.', arabic: 'الرجاء إدخال كلمة المرور لعرض البيانات المالية.'},
        currentPassword: { english: 'Current Password', arabic: 'كلمة المرور الحالية'}, newPassword: { english: 'New Password', arabic: 'كلمة المرور الجديدة'}, confirmPassword: { english: 'Confirm New Password', arabic: 'تأكيد كلمة المرور الجديدة'},
        dataManagement: { english: 'Data Management', arabic: 'إدارة البيانات' }, dataManagementDesc: { english: 'Application-level actions.', arabic: 'إجراءات على مستوى التطبيق.' }, resetDataWarning: { english: "Resetting data is not supported in database mode.", arabic: "إعادة تعيين البيانات غير مدعوم في وضع قاعدة البيانات." },
        downloadData: { english: 'Download Data', arabic: 'تنزيل البيانات' }, importData: { english: 'Import Data', arabic: 'استيراد البيانات' },
        addMemberTitle: { english: 'Add New Member', arabic: 'إضافة عضو جديد' }, editMemberTitle: { english: 'Edit Member', arabic: 'تعديل بيانات عضو' },
        firstName: { english: 'First Name', arabic: 'الاسم الأول' }, lastName: { english: 'Last Name', arabic: 'اسم العائلة' }, phone: { english: 'Phone', arabic: 'الهاتف' }, email: { english: 'Email', arabic: 'البريد الإلكتروني' }, emailOptional: { english: 'Email (Optional)', arabic: 'البريد (اختياري)'},
        prefLanguage: { english: 'Preferred Language', arabic: 'اللغة المفضلة' }, addRenewSubTitle: { english: 'Add/Renew Subscription', arabic: 'إضافة/تجديد اشتراك' }, subType: { english: 'Type', arabic: 'النوع' },
        startDate: { english: 'Start Date', arabic: 'تاريخ البدء' }, member: { english: 'Member', arabic: 'العضو' }, password: { english: 'Password', arabic: 'كلمة المرور' }, login: { english: 'Login', arabic: 'دخول' }, memberDetailsTitle: { english: 'Member Details', arabic: 'تفاصيل العضو' },
        selectPlaceholder: { english: 'Select...', arabic: 'اختر...' }, noMessages: { english: 'No message history.', arabic: 'لا يوجد سجل رسائل.' }, noSubData: { english: 'No subscription data.', arabic: 'لا توجد بيانات اشتراك.' }, noMembersFound: { english: 'No members found.', arabic: 'لم يتم العثور على أعضاء.' },
        subscriptionManagement: { english: 'Subscription Management', arabic: 'إدارة الاشتراكات' }, addSubType: { english: 'Add Subscription Type', arabic: 'إضافة نوع اشتراك' },
        subName: { english: 'Name', arabic: 'الاسم' }, durationInDays: { english: 'Duration (Days)', arabic: 'المدة (بالأيام)' }, price: { english: 'Price', arabic: 'السعر' },
        addTransaction: { english: 'Add Transaction', arabic: 'إضافة معاملة' }, date: { english: 'Date', arabic: 'التاريخ' }, description: { english: 'Description', arabic: 'الوصف' },
        type: { english: 'Type', arabic: 'النوع' }, amount: { english: 'Amount', arabic: 'المبلغ' }, income: { english: 'Income', arabic: 'إيراد' }, expense: { english: 'Expense', arabic: 'مصروف' },
        noSubTypes: { english: 'No subscription types defined.', arabic: 'لا توجد أنواع اشتراكات معرفة.' }, noTransactions: { english: 'No financial transactions recorded.', arabic: 'لا توجد معاملات مالية مسجلة.' },
        alertSubTypeAdded: { english: 'Subscription type added successfully.', arabic: 'تمت إضافة نوع الاشتراك بنجاح.'}, alertSubTypeUpdated: { english: 'Subscription type updated successfully.', arabic: 'تم تحديث نوع الاشتراك بنجاح.'},
        alertConfirmDeleteSubType: { english: 'Are you sure you want to delete this subscription type?', arabic: 'هل أنت متأكد من حذف نوع الاشتراك هذا؟' },
        alertTransactionAdded: { english: 'Transaction added successfully.', arabic: 'تمت إضافة المعاملة بنجاح.'},
        editTransaction: { english: 'Edit Transaction', arabic: 'تعديل المعاملة' },
        alertTransactionUpdated: { english: 'Transaction updated successfully.', arabic: 'تم تحديث المعاملة بنجاح.'},
        alertConfirmDeleteTransaction: { english: 'Are you sure you want to delete this transaction?', arabic: 'هل أنت متأكد من حذف هذه المعاملة؟' },
        transactionTypeOptions: { income: { english: "Income", arabic: "إيراد" }, expense: { english: "Expense", arabic: "مصروف" } },
        genderOptions: { male: { english: "Male", arabic: "ذكر" }, female: { english: "Female", arabic: "أنثى" } },
        languageOptions: { english: { english: "English", arabic: "الإنجليزية" }, arabic: { english: "Arabic", arabic: "العربية" } },
        recipientsOptions: { all: {english: "All Members", arabic: "كل الأعضاء"}, active: {english: "Active Subscribers", arabic: "المشتركون النشطون"}, expiring: {english: "Expiring Soon", arabic: "الاشتراكات المنتهية قريبا"}, male: {english: "Male Members", arabic: "الأعضاء الذكور"}, female: {english: "Female Members", arabic: "الأعضاء الإناث"}, individual: {english: "Individual Member", arabic: "عضو محدد"} },
        messageHistoryHeaders: {date: {english: "Date", arabic: "التاريخ"}, recipients: {english: "Recipients", arabic: "المستلمون"}, message: {english: "Message", arabic: "الرسالة"}, status: {english: "Status", arabic: "الحالة"} },
        subscriptionsReportHeaders: { memberName: {english: "Member Name", arabic: "اسم العضو"}, subType: {english: "Sub. Type", arabic: "نوع الاشتراك"}, startDate: {english: "Start Date", arabic: "تاريخ البدء"}, endDate: {english: "End Date", arabic: "تاريخ الانتهاء"}, status: {english: "Status", arabic: "الحالة"} },
        alertImportSuccess: { english: 'Data imported successfully! The page will now refresh.', arabic: 'تم استيراد البيانات بنجاح! سيتم تحديث الصفحة الآن.' },
        alertImportError: { english: 'Error importing data. Please ensure the file is a valid JSON export from this application.', arabic: 'خطأ في استيراد البيانات. يرجى التأكد من أن الملف هو تصدير JSON صالح من هذا التطبيق.' },
        alertMemberAdded: { english: "Member added successfully!", arabic: "تمت إضافة العضو بنجاح!" },
        alertMemberUpdated: { english: "Member details updated.", arabic: "تم تحديث بيانات العضو." },
        alertConfirmDelete: { english: "Are you sure you want to delete this member?", arabic: "هل أنت متأكد من رغبتك في حذف هذا العضو؟" },
        alertMemberDeleted: { english: "Member deleted.", arabic: "تم حذف العضو." },
        alertSubUpdated: { english: "Subscription saved successfully.", arabic: "تم حفظ الاشتراك بنجاح." },
        alertIncorrectPassword: { english: "Incorrect password.", arabic: "كلمة المرور غير صحيحة." },
        formValidation: { english: "Please fill in all required fields.", arabic: "يرجى ملء جميع الحقول المطلوبة." },
        alertInvalidDate: { english: 'Invalid start date.', arabic: 'تاريخ البدء غير صالح.'},
        alertSelectIndividual: { english: 'Please select an individual member.', arabic: 'الرجاء اختيار عضو محدد.'},
        alertEmptyMessage: { english: 'Message content cannot be empty.', arabic: 'محتوى الرسالة لا يمكن أن يكون فارغًا.'},
        alertMessageSentTo: (recipient) => ({ english: `SMS successfully sent to: ${recipient}`, arabic: `تم إرسال الرسالة بنجاح إلى: ${recipient}`}[currentLanguage]),
        alertSmsApiFailure: { english: 'SMS API simulation failed. Check the console for details.', arabic: 'فشلت محاكاة إرسال الرسائل. تحقق من الـ console للمزيد من التفاصيل.'},
        alertNoValidPhones: { english: 'No members with valid phone numbers in the selected group.', arabic: 'لا يوجد أعضاء بأرقام هواتف صالحة في المجموعة المحددة.'},
        alertPasswordMismatch: { english: 'New passwords do not match.', arabic: 'كلمتا المرور الجديدتان غير متطابقتين.'},
        alertPasswordEmpty: { english: 'New password cannot be empty.', arabic: 'كلمة المرور الجديدة لا يمكن أن تكون فارغة.'},
        alertPasswordChanged: { english: 'Password changed successfully.', arabic: 'تم تغيير كلمة المرور بنجاح.'}
    };


    // --- STARTUP & AUTHENTICATION (New Advanced Version) ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('password').focus();
        setLanguage(currentLanguage);
    });

    async function handleLogin(e) {
        e.preventDefault();
        const passwordInput = document.getElementById('password');
        const errorMsg = document.getElementById('login-error-msg');
        passwordInput.disabled = true;
        document.body.style.cursor = 'wait';
        
        await fetchAndSetPasswords();

        document.body.style.cursor = 'default';
        passwordInput.disabled = false;

        if (passwords.system_password && passwordInput.value === passwords.system_password) {
            errorMsg.style.display = 'none';
            document.getElementById('login-screen').style.display = 'none';
            document.querySelector('.main-container').classList.remove('d-none');
            initializeApp();
        } else {
            errorMsg.style.display = 'block';
            passwordInput.value = '';
        }
    }

    async function fetchAndSetPasswords() {
        try {
            const response = await fetch(`${SHEETDB_API_URL}?sheet=${SHEETS.passwords}`);
            if (!response.ok) throw new Error(`Network error: ${response.status}`);
            const data = await response.json();
            
            if (data && data.length > 0) {
                passwords = data.reduce((obj, item) => {
                    if (item.key) obj[item.key] = item.value;
                    return obj;
                }, {});
            }
            // Set default passwords if they are not found in the sheet
            if (!passwords.system_password) passwords.system_password = 'admin123';
            if (!passwords.financials_password) passwords.financials_password = 'finance456';

        } catch (error) {
            console.error("Could not fetch passwords from SheetDB. Using default passwords.", error);
            passwords.system_password = 'admin123';
            passwords.financials_password = 'finance456';
        }
    }


    // --- INITIALIZE APP & DATA FETCHING (New Robust Version) ---
    async function initializeApp() {
        console.log("Vorta Fitness Initializing from SheetDB...");
        document.body.style.cursor = 'wait';
        try {
            // Use Promise.allSettled to ensure the app loads even if one sheet fails
            const results = await Promise.allSettled([
                fetch(`${SHEETDB_API_URL}?sheet=${SHEETS.members}`).then(res => res.json()),
                fetch(`${SHEETDB_API_URL}?sheet=${SHEETS.transactions}`).then(res => res.json()),
                fetch(`${SHEETDB_API_URL}?sheet=${SHEETS.subscriptionTypes}`).then(res => res.json()),
                fetch(`${SHEETDB_API_URL}?sheet=${SHEETS.messageHistory}`).then(res => res.json())
            ]);

            members = results[0].status === 'fulfilled' ? results[0].value.map(m => parseMember(m)).sort((a,b) => a.id - b.id) : [];
            transactions = results[1].status === 'fulfilled' ? results[1].value.map(t => parseTransaction(t)).sort((a,b) => b.date - a.date) : [];
            subscriptionTypes = results[2].status === 'fulfilled' ? results[2].value.map(st => parseSubType(st)).sort((a,b) => a.id - b.id) : [];
            messageHistory = results[3].status === 'fulfilled' ? results[3].value.map(msg => parseMessage(msg)).sort((a,b) => b.sentAt - a.sentAt) : [];
            
            setupEventListeners();
            showTab('dashboard');
            console.log("Vorta Fitness is Ready.");

        } catch (error) {
            console.error("Failed to initialize app data:", error);
            alert("فشل في تحميل البيانات من قاعدة البيانات. يرجى التأكد من اتصالك بالإنترنت وتحديث الصفحة.");
        } finally {
            document.body.style.cursor = 'default';
        }
    }


    // --- DATA PARSING FUNCTIONS (FIXED & ROBUST from Code 1) ---
    function parseMember(m) {
        return {
            ...m,
            id: Number(m.id),
            createdAt: m.createdAt ? new Date(m.createdAt) : new Date(), // Important: Provides a default date
            subscriptionActive: m.subscriptionActive === 'TRUE', 
            subscription: m.subscriptionActive === 'TRUE' ? {
                id: m.subscriptionId ? Number(m.subscriptionId) : null,
                type: m.subscriptionType,
                price: m.subscriptionPrice ? Number(m.subscriptionPrice) : 0,
                startDate: m.subscriptionStartDate ? new Date(m.subscriptionStartDate) : new Date(),
                endDate: m.subscriptionEndDate ? new Date(m.subscriptionEndDate) : new Date(),
                active: true
            } : null
        };
    }

    function parseTransaction(t) {
        return { ...t, id: Number(t.id), amount: Number(t.amount), date: t.date ? new Date(t.date) : new Date(), memberId: t.memberId ? Number(t.memberId) : null };
    }

    function parseSubType(st) {
        return {
            ...st,
            id: Number(st.id),
            durationDays: Number(st.durationDays),
            price: Number(st.price),
            name: { english: st.name_english, arabic: st.name_arabic }
        };
    }

    function parseMessage(msg) {
        return { ...msg, sentAt: msg.sentAt ? new Date(msg.sentAt) : new Date() };
    }


    // --- EVENT LISTENERS & NAVIGATION (with Financials Protection) ---
    function setupEventListeners() {
        document.querySelector('.main-sidebar').addEventListener('click', handleNavClick);
        document.querySelector('.btn-group-lang').addEventListener('click', (e) => e.target.closest('[data-lang]') && setLanguage(e.target.dataset.lang));
        
        ['add-member-form', 'edit-member-form', 'subscription-form', 'subscription-type-form', 'add-transaction-form', 'message-form'].forEach(id => {
            document.getElementById(id)?.addEventListener('submit', (e) => {
                e.preventDefault();
                const formActions = {
                    'add-member-form': addMember, 'edit-member-form': saveMemberChanges,
                    'subscription-form': saveSubscription, 'subscription-type-form': saveSubscriptionType,
                    'add-transaction-form': saveTransaction, 'message-form': sendMessage
                };
                formActions[id]?.();
            });
        });

        document.getElementById('member-search').addEventListener('input', () => filterMembersTable());
        document.getElementById('message-recipients').addEventListener('change', (e) => document.getElementById('individual-select-container').classList.toggle('d-none', e.target.value !== 'individual'));
        
        document.getElementById('dashboard-tab').addEventListener('click', (e) => {
            const card = e.target.closest('.clickable-card');
            if (card) {
                dashboardFilter = card.dataset.filter;
                document.getElementById('member-search').value = '';
                document.querySelectorAll("#members-tab .btn-group button").forEach(btn => btn.classList.toggle('active', btn.dataset.gender === 'all'));
                showTab('members');
            }
        });

        document.getElementById('add-member-subscription-type').addEventListener('change', (e) => {
            const subTypeId = e.target.value;
            const priceInput = document.getElementById('add-member-subscription-price');
            if (subTypeId) {
                const subType = subscriptionTypes.find(st => st.id == subTypeId);
                priceInput.value = subType ? subType.price : '';
            } else { priceInput.value = ''; }
        });
        
        document.getElementById('addMemberModal').addEventListener('show.bs.modal', populateAddMemberModal);
        document.getElementById('subscriptionModal').addEventListener('show.bs.modal', populateSubscriptionModal);
        document.getElementById('financials-password-form').addEventListener('submit', handleFinancialsPasswordSubmit);
    }
    
    function handleNavClick(e) {
        const navLink = e.target.closest('[data-tab]');
        if (navLink) { e.preventDefault(); showTab(navLink.dataset.tab); }
    }

    function showTab(tabName) {
        // Intercept navigation to the financials tab
        if (tabName === 'financials') {
            const financialsModalEl = document.getElementById('financialsPasswordModal');
            const financialsModal = bootstrap.Modal.getOrCreateInstance(financialsModalEl);
            financialsModal.show();
            // Clear previous attempts and focus
            document.getElementById('financials-password-input').value = '';
            document.getElementById('financials-password-error').classList.add('d-none');
            setTimeout(() => document.getElementById('financials-password-input').focus(), 500);
            return; // Stop further execution until password is submitted
        }

        _showTab(tabName);
    }

    function handleFinancialsPasswordSubmit(e) {
        e.preventDefault();
        const input = document.getElementById('financials-password-input');
        const errorMsg = document.getElementById('financials-password-error');
        
        if (input.value === passwords.financials_password) {
            errorMsg.classList.add('d-none');
            const financialsModal = bootstrap.Modal.getInstance(document.getElementById('financialsPasswordModal'));
            financialsModal.hide();
            _showTab('financials'); // Show the tab after successful login
            loadFinancialsPage();
        } else {
            errorMsg.classList.remove('d-none');
            input.value = '';
        }
    }

    function _showTab(tabName) {
        currentTab = tabName;
        document.querySelectorAll('.content-tab').forEach(tab => tab.classList.add('d-none'));
        document.getElementById(`${tabName}-tab`).classList.remove('d-none');
        document.querySelectorAll('.main-sidebar [data-tab]').forEach(link => {
            link.classList.remove('active');
            if (link.dataset.tab === tabName || (tabName === 'financials' && link.dataset.tab === 'financials')) {
                link.classList.add('active');
            }
        });
        
        const tabActions = { dashboard: refreshDashboard, members: loadMembers, subscriptions: loadSubscriptionsPage, messaging: loadMessagingPage, reports: loadReportsPage, settings: loadSettingsPage };
        tabActions[tabName]?.();
    }
    
    function setLanguage(lang) {
        currentLanguage = lang; localStorage.setItem('vortaFitnessLanguage', lang);
        document.documentElement.dir = lang === 'arabic' ? 'rtl' : 'ltr'; document.documentElement.lang = lang === 'arabic' ? 'ar' : 'en';
        document.querySelectorAll('.btn-group-lang button').forEach(btn => btn.classList.toggle('active', btn.dataset.lang === lang));
        
        document.querySelectorAll('[data-translate]').forEach(el => { const key = el.getAttribute('data-translate'); if(translations[key]?.[lang]){ el.placeholder ? el.placeholder = translations[key][lang] : el.textContent = translations[key][lang]; } });
        document.querySelectorAll('[data-translate-options]').forEach(sel => { const key = sel.getAttribute('data-translate-options'); sel.innerHTML = Object.entries(translations[key]).map(([val, trans]) => `<option value="${val}">${trans[lang]}</option>`).join(''); });
        document.querySelectorAll('[data-translate-headers]').forEach(thead => { const key = thead.getAttribute('data-translate-headers'); thead.rows[0].innerHTML = Object.values(translations[key]).map(trans => `<th>${trans[lang]}</th>`).join(''); });

        if (!document.querySelector('.main-container.d-none')) {
            const tabActions = { dashboard: refreshDashboard, members: loadMembers, financials: loadFinancialsPage, subscriptions: loadSubscriptionsPage, messaging: loadMessagingPage, reports: loadReportsPage, settings: loadSettingsPage };
            tabActions[currentTab]?.();
        }
    }

    function refreshAllDynamicContent() { _showTab(currentTab); }
    
    // --- SETTINGS PAGE & PASSWORD MANAGEMENT (New Dynamic Version) ---
    function loadSettingsPage() {
        const container = document.getElementById('settings-cards-container');
        container.innerHTML = `
            <div class="col-lg-4 col-md-6">
                <div class="card bg-surface h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title" data-translate="changePassword">Change System Password</h5>
                        <p class="text-muted small" data-translate="changePasswordDesc">Update the system access password.</p>
                        <form id="change-system-password-form" class="mt-auto">
                            <div class="mb-3"><label for="current-system-password" class="form-label" data-translate="currentPassword">Current Password</label><input type="password" id="current-system-password" class="form-control" required></div>
                            <div class="mb-3"><label for="new-system-password" class="form-label" data-translate="newPassword">New Password</label><input type="password" id="new-system-password" class="form-control" required></div>
                            <div class="mb-3"><label for="confirm-system-password" class="form-label" data-translate="confirmPassword">Confirm New Password</label><input type="password" id="confirm-system-password" class="form-control" required></div>
                            <button type="submit" class="btn btn-primary" data-translate="saveChanges">Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="card bg-surface h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title" data-translate="changeFinancialsPassword">Change Financials Password</h5>
                        <p class="text-muted small" data-translate="changeFinancialsPasswordDesc">Update the password for the financials tab.</p>
                        <form id="change-financials-password-form" class="mt-auto">
                            <div class="mb-3"><label for="current-financials-password" class="form-label" data-translate="currentPassword">Current Password</label><input type="password" id="current-financials-password" class="form-control" required></div>
                            <div class="mb-3"><label for="new-financials-password" class="form-label" data-translate="newPassword">New Password</label><input type="password" id="new-financials-password" class="form-control" required></div>
                            <div class="mb-3"><label for="confirm-financials-password" class="form-label" data-translate="confirmPassword">Confirm New Password</label><input type="password" id="confirm-financials-password" class="form-control" required></div>
                            <button type="submit" class="btn btn-primary" data-translate="saveChanges">Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-12">
                <div class="card bg-surface h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title" data-translate="dataManagement">Data Management</h5>
                        <p class="text-muted small" data-translate="dataManagementDesc">Application-level actions.</p>
                        <div class="mb-3">
                            <button id="download-data-btn" class="btn btn-success me-2"><i class="fas fa-download me-2"></i><span data-translate="downloadData">Download Data</span></button>
                            <label for="import-data-input" class="btn btn-info"><i class="fas fa-upload me-2"></i><span data-translate="importData">Import Data</span></label>
                            <input type="file" id="import-data-input" class="d-none" accept=".json">
                        </div>
                        <div class="mt-auto">
                            <p class="small text-warning" data-translate="resetDataWarning">Warning: Resetting data is not supported in database mode.</p>
                        </div>
                    </div>
                </div>
            </div>`;
        
        container.querySelector('#change-system-password-form').addEventListener('submit', handleChangeSystemPassword);
        container.querySelector('#change-financials-password-form').addEventListener('submit', handleChangeFinancialsPassword);
        container.querySelector('#download-data-btn').addEventListener('click', downloadDataAsJSON);
        container.querySelector('#import-data-input').addEventListener('change', importDataFromJSON);
        setLanguage(currentLanguage); // Apply translations to newly added content
    }
    
    async function updatePasswordOnSheetDB(passwordKey, newPassword) {
        try {
            const response = await fetch(`${SHEETDB_API_URL}/key/${passwordKey}?sheet=${SHEETS.passwords}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: { value: newPassword } })
            });
            if (!response.ok) throw new Error(`Failed to update ${passwordKey}.`);
            
            passwords[passwordKey] = newPassword; // Update local state
            alert(translations.alertPasswordChanged[currentLanguage]);
            return true;
        } catch (error) {
            console.error(error);
            alert(`An error occurred while changing the password.`);
            return false;
        }
    }
    
    async function handleChangeSystemPassword(e) {
        e.preventDefault();
        const form = e.target;
        const currentPass = form.querySelector('#current-system-password').value;
        const newPass = form.querySelector('#new-system-password').value;
        const confirmPass = form.querySelector('#confirm-system-password').value;

        if (currentPass !== passwords.system_password) return alert(translations.alertIncorrectPassword[currentLanguage]);
        if (!newPass) return alert(translations.alertPasswordEmpty[currentLanguage]);
        if (newPass !== confirmPass) return alert(translations.alertPasswordMismatch[currentLanguage]);
        
        const success = await updatePasswordOnSheetDB('system_password', newPass);
        if (success) form.reset();
    }
    
    async function handleChangeFinancialsPassword(e) {
        e.preventDefault();
        const form = e.target;
        const currentPass = form.querySelector('#current-financials-password').value;
        const newPass = form.querySelector('#new-financials-password').value;
        const confirmPass = form.querySelector('#confirm-financials-password').value;

        if (currentPass !== passwords.financials_password) return alert(translations.alertIncorrectPassword[currentLanguage]);
        if (!newPass) return alert(translations.alertPasswordEmpty[currentLanguage]);
        if (newPass !== confirmPass) return alert(translations.alertPasswordMismatch[currentLanguage]);
        
        const success = await updatePasswordOnSheetDB('financials_password', newPass);
        if (success) form.reset();
    }
    

    // --- All other functions from Code 1 (proven to be stable) ---
    // The following functions are copied from the stable version (Code 1), with minor adaptations for the new features.

    function refreshDashboard(){const t=members.length,a=members.filter(m=>m.subscription?.active).length,u=t-a,o=new Date;o.setHours(0,0,0,0);const e=new Date;e.setDate(o.getDate()+EXPIRATION_REMINDER_DAYS);const r=members.filter(m=>m.subscription?.active&&new Date(m.subscription.endDate)>=o&&new Date(m.subscription.endDate)<=e).length;document.getElementById("total-members").textContent=t,document.getElementById("active-subscriptions").textContent=a,document.getElementById("expiring-subscriptions").textContent=r,document.getElementById("unsubscribed-members").textContent=u;const n=transactions.filter(t=>"income"===t.type).reduce((t,a)=>t+a.amount,0),s=transactions.filter(t=>"expense"===t.type).reduce((t,a)=>t+a.amount,0),i=n-s;document.getElementById("total-income").textContent=formatCurrency(n),document.getElementById("total-expenses").textContent=formatCurrency(s),document.getElementById("net-profit").textContent=formatCurrency(i),renderDashboardCharts()}
    function renderDashboardCharts(){if("undefined"==typeof Chart)return;const t=members.filter(t=>"male"===t.gender).length,a=members.filter(t=>"female"===t.gender).length,o=document.getElementById("genderDistributionChart").getContext("2d");genderChart&&genderChart.destroy(),genderChart=new Chart(o,{type:"doughnut",data:{labels:["Male","Female"],datasets:[{data:[t,a],backgroundColor:["#0d6efd","#dc3545"],borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top",labels:{color:"#f8f9fa"}}}}});const e=members.reduce((t,a)=>{if(a.subscription?.active){const o=subscriptionTypes.find(t=>t.name.english===a.subscription.type||t.name.arabic===a.subscription.type)?.name[currentLanguage]||a.subscription.type||"Unknown";t[o]=(t[o]||0)+1}return t},{}),r=document.getElementById("subscriptionTypeChart").getContext("2d");subscriptionChart&&subscriptionChart.destroy(),subscriptionChart=new Chart(r,{type:"bar",data:{labels:Object.keys(e),datasets:[{data:Object.values(e),backgroundColor:["#198754","#ffc107","#0dcaf0","#6f42c1","#e83e8c"]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,grid:{color:"#3b3e47"},ticks:{color:"#f8f9fa",stepSize:1}},x:{grid:{display:!1},ticks:{color:"#f8f9fa"}}}}})}
    function loadMembers(){let t=[...members];if(dashboardFilter){const a=new Date;a.setHours(0,0,0,0);const o=new Date;o.setDate(a.getDate()+EXPIRATION_REMINDER_DAYS);switch(dashboardFilter){case"active":t=t.filter(t=>t.subscription&&t.subscription.active);break;case"expiring":t=t.filter(t=>t.subscription?.active&&new Date(t.subscription.endDate)>=a&&new Date(t.subscription.endDate)<=o);break;case"unsubscribed":t=t.filter(t=>!t.subscription||!t.subscription.active)}dashboardFilter=null}const a=document.querySelector("#members-tab .btn-group button.active").dataset.gender;"all"!==a&&(t=t.filter(t=>t.gender===a));const o=document.getElementById("member-search").value.toLowerCase();o&&(t=t.filter(t=>`${t.firstName} ${t.lastName}`.toLowerCase().includes(o)||t.phone.includes(o)||t.email?.toLowerCase().includes(o))),renderMembersTable(t)}
    function filterMembersByGender(t){document.querySelectorAll("#members-tab .btn-group button").forEach(a=>a.classList.toggle("active",a.dataset.gender===t)),loadMembers()}
    function filterMembersTable(){loadMembers()}
    function renderMembersTable(t){const a=document.getElementById("members-table").querySelector("tbody");if(a.innerHTML="",0===t.length)return void(a.innerHTML=`<tr><td colspan="7" class="text-center py-4" data-translate="noMembersFound">${translations.noMembersFound[currentLanguage]}</td></tr>`);const o=new Date;o.setHours(0,0,0,0),t.forEach(t=>{let e,r;t.subscription?(r=new Date(t.subscription.endDate),e=Math.ceil((r-o)/864e5),!t.subscription.active||e<0?(e="Expired",r="danger"):e<=EXPIRATION_REMINDER_DAYS?(e=`Expiring (${e}d)`,r="warning"):(e="Active",r="success")):(e="None",r="secondary");const n=a.insertRow();n.innerHTML=`<td>${t.id}</td><td>${t.firstName} ${t.lastName}</td><td><i class="fas fa-${"male"===t.gender?"male text-primary":"female text-danger"} me-2"></i> ${t.gender}</td><td><div>${t.phone}</div><div class="small text-muted">${t.email||""}</div></td><td class="text-capitalize">${t.subscription?.type||"N/A"}</td><td><span class="badge bg-${r}">${e}</span></td><td><div class="dropdown"><button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-translate="actions">${translations.actions[currentLanguage]}</button><ul class="dropdown-menu dropdown-menu-dark"><li><a class="dropdown-item" href="#" onclick="viewMember(${t.id})"><i class="fas fa-eye fa-fw me-2"></i><span data-translate="view">${translations.view[currentLanguage]}</span></a></li><li><a class="dropdown-item" href="#" onclick="editMember(${t.id})"><i class="fas fa-edit fa-fw me-2"></i><span data-translate="edit">${translations.edit[currentLanguage]}</span></a></li><li><a class="dropdown-item" href="#" onclick="addSubscriptionForMember(${t.id})"><i class="fas fa-sync fa-fw me-2"></i><span data-translate="renewSub">${translations.renewSub[currentLanguage]}</span></a></li><li><hr class="dropdown-divider"></li><li><a class="dropdown-item text-danger" href="#" onclick="deleteMember(${t.id})"><i class="fas fa-trash fa-fw me-2"></i><span data-translate="delete">${translations.delete[currentLanguage]}</span></a></li></ul></div></td>`})}
    async function addMember(){const t=document.getElementById("add-member-form"),a=t.querySelector("#add-first-name").value.trim(),o=t.querySelector("#add-last-name").value.trim(),e=t.querySelector("#add-phone").value.trim();if(!a||!o||!e)return alert(translations.formValidation[currentLanguage]);const r=members.length>0?Math.max(...members.map(t=>t.id))+1:1,n={id:r,firstName:a,lastName:o,phone:e,email:t.querySelector("#add-email").value.trim(),gender:t.querySelector("#add-gender").value,language:t.querySelector("#add-language").value,createdAt:(new Date).toISOString()};let s=null;const i=t.querySelector("#add-member-subscription-type").value;if(i){const t=subscriptionTypes.find(t=>t.id==i);if(t){const d=new Date,c=new Date(d);c.setDate(d.getDate()+t.durationDays),n.subscriptionId=Date.now(),n.subscriptionType=t.name.english,n.subscriptionPrice=t.price,n.subscriptionStartDate=d.toISOString(),n.subscriptionEndDate=c.toISOString(),n.subscriptionActive="TRUE",s={id:transactions.length>0?Math.max(...transactions.map(t=>t.id))+1:1,date:(new Date).toISOString(),description:`Subscription: ${a} ${o}`,type:"income",amount:t.price,memberId:r}}}try{const a=await fetch(`${SHEETDB_API_URL}?sheet=${SHEETS.members}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:[n]})});if(!(await a.json()).created)throw new Error("SheetDB failed to create member.");if(s){await fetch(`${SHEETDB_API_URL}?sheet=${SHEETS.transactions}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:[s]})}),transactions.push(parseTransaction(s))}members.push(parseMember(n)),bootstrap.Modal.getInstance(t.closest(".modal")).hide(),t.reset(),alert(translations.alertMemberAdded[currentLanguage]),refreshAllDynamicContent()}catch(t){console.error("Failed to add member:",t),alert("فشل في إضافة العضو. يرجى المحاولة مرة أخرى.")}}
    function editMember(t){const a=members.find(a=>a.id===t);if(!a)return;const o=document.getElementById("edit-member-form");o.querySelector("#edit-member-id").value=a.id,o.querySelector("#edit-first-name").value=a.firstName,o.querySelector("#edit-last-name").value=a.lastName,o.querySelector("#edit-phone").value=a.phone,o.querySelector("#edit-email").value=a.email||"",o.querySelector("#edit-gender").value=a.gender,o.querySelector("#edit-language").value=a.language;new bootstrap.Modal(o.closest(".modal")).show()}
    async function saveMemberChanges(){const t=document.getElementById("edit-member-form"),a=parseInt(t.querySelector("#edit-member-id").value),o={firstName:t.querySelector("#edit-first-name").value.trim(),lastName:t.querySelector("#edit-last-name").value.trim(),phone:t.querySelector("#edit-phone").value.trim(),email:t.querySelector("#edit-email").value.trim(),gender:t.querySelector("#edit-gender").value,language:t.querySelector("#edit-language").value};try{const e=await fetch(`${SHEETDB_API_URL}/id/${a}?sheet=${SHEETS.members}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:o})});if((await e.json()).updated){const t=members.findIndex(t=>t.id===a);t>-1&&(members[t]={...members[t],...o}),bootstrap.Modal.getInstance(document.getElementById("edit-member-form").closest(".modal")).hide(),alert(translations.alertMemberUpdated[currentLanguage]),refreshAllDynamicContent()}else throw new Error("SheetDB failed to update record.")}catch(t){console.error("Failed to update member:",t),alert("فشل في تعديل بيانات العضو. يرجى المحاولة مرة أخرى.")}}
    async function deleteMember(t){if(confirm(translations.alertConfirmDelete[currentLanguage]))try{const a=await fetch(`${SHEETDB_API_URL}/id/${t}?sheet=${SHEETS.members}`,{method:"DELETE"});if((await a.json()).deleted)members=members.filter(a=>a.id!==t),alert(translations.alertMemberDeleted[currentLanguage]),refreshAllDynamicContent();else throw new Error("SheetDB failed to delete record.")}catch(t){console.error("Failed to delete member:",t),alert("فشل في حذف العضو. يرجى المحاولة مرة أخرى.")}}
    function viewMember(t){const a=members.find(a=>a.id===t);if(!a)return;let o=`<p>${translations.unsubscribed[currentLanguage]}</p>`;if(a.subscription){const t=a.subscription.type,e=(new Date(a.subscription.endDate)).toLocaleDateString(),r=formatCurrency(a.subscription.price);o=`<p><strong>${translations.subscription[currentLanguage]}:</strong> ${t}</p><p><strong>${translations.price[currentLanguage]}:</strong> ${r}</p><p><strong>Ends:</strong> ${e}</p>`}document.getElementById("viewMemberModalBody").innerHTML=`<h6>${a.firstName} ${a.lastName} <span class="badge bg-secondary">ID:${a.id}</span></h6><hr><p><strong>${translations.phone[currentLanguage]}:</strong> ${a.phone}</p>${o}`;new bootstrap.Modal(document.getElementById("viewMemberModal")).show()}
    function addSubscriptionForMember(t){const a=members.find(a=>a.id===t);if(!a)return;const o=document.getElementById("subscription-form");o.querySelector("#subscription-member-id").value=t,o.querySelector("#subscription-member-name").textContent=`${a.firstName} ${a.lastName}`,o.querySelector("#subscription-start-date").valueAsDate=new Date;new bootstrap.Modal(o.closest(".modal")).show()}
    async function saveSubscription(){const t=document.getElementById("subscription-form"),a=parseInt(t.querySelector("#subscription-member-id").value),o=members.findIndex(t=>t.id===a);if(-1===o)return;const e=t.querySelector("#subscription-modal-type").value,r=subscriptionTypes.find(t=>t.id==e);if(!r)return;const n=new Date(t.querySelector("#subscription-start-date").value);if(isNaN(n.getTime()))return alert(translations.alertInvalidDate[currentLanguage]);const s=new Date(n);s.setDate(n.getDate()+r.durationDays);const i={subscriptionId:Date.now(),subscriptionType:r.name.english,subscriptionPrice:r.price,subscriptionStartDate:n.toISOString(),subscriptionEndDate:s.toISOString(),subscriptionActive:"TRUE"},d={id:transactions.length>0?Math.max(...transactions.map(t=>t.id))+1:1,date:(new Date).toISOString(),description:`Subscription: ${members[o].firstName} ${members[o].lastName}`,type:"income",amount:r.price,memberId:a};try{const response=await fetch(`${SHEETDB_API_URL}/id/${a}?sheet=${SHEETS.members}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:i})});if(!response.ok)throw new Error("Failed to update subscription.");const c=await fetch(`${SHEETDB_API_URL}?sheet=${SHEETS.transactions}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:[d]})});if(!c.ok)throw new Error("Failed to create transaction.");members[o]=parseMember({...members[o],...i}),transactions.push(parseTransaction(d));const e=t.closest(".modal");bootstrap.Modal.getInstance(e).hide(),alert(translations.alertSubUpdated[currentLanguage]),refreshAllDynamicContent()}catch(t){console.error(t),alert("An error occurred while saving the subscription.")}}
    function loadFinancialsPage(){const t=document.getElementById("financials-table").querySelector("tbody");if(t.innerHTML="",0===transactions.length)return void(t.innerHTML=`<tr><td colspan="5" class="text-center py-4" data-translate="noTransactions">${translations.noTransactions[currentLanguage]}</td></tr>`);transactions.sort((t,a)=>new Date(a.date)-new Date(t.date)).forEach(a=>{const o=t.insertRow(),e="income"===a.type?"text-success":"text-danger";o.innerHTML=`<td>${(new Date(a.date)).toLocaleDateString()}</td><td>${a.description}</td><td><span class="${e} fw-bold">${translations[a.type][currentLanguage]}</span></td><td class="text-end ${e} fw-bold">${formatCurrency(a.amount)}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary me-2" onclick="prepareEditTransactionModal(${a.id})"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction(${a.id})"><i class="fas fa-trash"></i></button></td>`})}
    function prepareAddTransactionModal(){const t=document.getElementById("add-transaction-form");t.reset(),t.querySelector("#transaction-id").value="",document.getElementById("transactionModalLabel").textContent=translations.addTransaction[currentLanguage]}
    function prepareEditTransactionModal(t){const a=transactions.find(a=>a.id===t);if(!a)return;const o=document.getElementById("add-transaction-form");o.reset(),document.getElementById("transactionModalLabel").textContent=translations.editTransaction[currentLanguage],o.querySelector("#transaction-id").value=a.id,o.querySelector("#transaction-type").value=a.type,o.querySelector("#transaction-description").value=a.description,o.querySelector("#transaction-amount").value=a.amount;new bootstrap.Modal(document.getElementById("addTransactionModal")).show()}
    async function saveTransaction(){const t=document.getElementById("add-transaction-form"),a=t.querySelector("#transaction-id").value,o=t.querySelector("#transaction-type").value,e=t.querySelector("#transaction-description").value.trim(),r=parseFloat(t.querySelector("#transaction-amount").value);if(!e||isNaN(r)||r<0)return alert(translations.formValidation[currentLanguage]);try{if(a){const t={type:o,description:e,amount:r},n=await fetch(`${SHEETDB_API_URL}/id/${a}?sheet=${SHEETS.transactions}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:t})});if(!n.ok)throw new Error("Failed to update transaction.");const s=transactions.findIndex(t=>t.id==a);s>-1&&(transactions[s]={...transactions[s],...t}),alert(translations.alertTransactionUpdated[currentLanguage])}else{const a=transactions.length>0?Math.max(...transactions.map(t=>t.id))+1:1,r={id:a,date:(new Date).toISOString(),type:o,description:e,amount:r},n=await fetch(`${SHEETDB_API_URL}?sheet=${SHEETS.transactions}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:[r]})});if(!n.ok)throw new Error("Failed to add transaction.");transactions.push(parseTransaction(r)),alert(translations.alertTransactionAdded[currentLanguage])}bootstrap.Modal.getInstance(t.closest(".modal")).hide(),refreshAllDynamicContent()}catch(t){console.error(t),alert("An error occurred while saving the transaction.")}}
    async function deleteTransaction(t){if(confirm(translations.alertConfirmDeleteTransaction[currentLanguage]))try{const a=await fetch(`${SHEETDB_API_URL}/id/${t}?sheet=${SHEETS.transactions}`,{method:"DELETE"});if(!a.ok)throw new Error("Failed to delete transaction.");transactions=transactions.filter(a=>a.id!==t),refreshAllDynamicContent()}catch(t){console.error(t),alert("An error occurred while deleting the transaction.")}}
    function loadSubscriptionsPage(){const t=document.getElementById("subscription-types-table").querySelector("tbody");if(t.innerHTML="",0===subscriptionTypes.length)return void(t.innerHTML=`<tr><td colspan="4" class="text-center py-4" data-translate="noSubTypes">${translations.noSubTypes[currentLanguage]}</td></tr>`);subscriptionTypes.forEach(a=>{const o=t.insertRow();o.innerHTML=`<td>${a.name[currentLanguage]}</td><td>${a.durationDays}</td><td>${formatCurrency(a.price)}</td><td><button class="btn btn-sm btn-outline-primary me-2" onclick="prepareSubscriptionTypeModal(${a.id})"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteSubscriptionType(${a.id})"><i class="fas fa-trash"></i></button></td>`})}
    function prepareSubscriptionTypeModal(t){const a=document.getElementById("subscription-type-form"),o=document.getElementById("subscriptionTypeModalLabel");if(a.reset(),t){const e=subscriptionTypes.find(a=>a.id===t);e&&(o.textContent=`${translations.edit[currentLanguage]}: ${e.name[currentLanguage]}`,a.querySelector("#sub-type-id").value=e.id,a.querySelector("#sub-type-name-en").value=e.name.english,a.querySelector("#sub-type-name-ar").value=e.name.arabic,a.querySelector("#sub-type-duration").value=e.durationDays,a.querySelector("#sub-type-price").value=e.price)}else o.textContent=translations.addSubType[currentLanguage],a.querySelector("#sub-type-id").value=""}
    async function saveSubscriptionType(){const t=document.getElementById("subscription-type-form"),a=t.querySelector("#sub-type-id").value,o=t.querySelector("#sub-type-name-en").value.trim(),e=t.querySelector("#sub-type-name-ar").value.trim(),r=parseInt(t.querySelector("#sub-type-duration").value),n=parseFloat(t.querySelector("#sub-type-price").value);if(!o||!e||isNaN(r)||r<=0||isNaN(n)||n<0)return alert(translations.formValidation[currentLanguage]);try{if(a){const t={name_english:o,name_arabic:e,durationDays:r,price:n},s=await fetch(`${SHEETDB_API_URL}/id/${a}?sheet=${SHEETS.subscriptionTypes}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:t})});if(!s.ok)throw new Error("Failed to update subscription type.");const i=subscriptionTypes.findIndex(t=>t.id==a);i>-1&&(subscriptionTypes[i]={...subscriptionTypes[i],name:{english:o,arabic:e},durationDays:r,price:n}),alert(translations.alertSubTypeUpdated[currentLanguage])}else{const a=subscriptionTypes.length>0?Math.max(...subscriptionTypes.map(t=>t.id))+1:1,n={id:a,name_english:o,name_arabic:e,durationDays:r,price:n},s=await fetch(`${SHEETDB_API_URL}?sheet=${SHEETS.subscriptionTypes}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:[n]})});if(!s.ok)throw new Error("Failed to add subscription type.");subscriptionTypes.push(parseSubType(n)),alert(translations.alertSubTypeAdded[currentLanguage])}bootstrap.Modal.getInstance(t.closest(".modal")).hide(),refreshAllDynamicContent()}catch(t){console.error(t),alert("An error occurred while saving the subscription type.")}}
    async function deleteSubscriptionType(t){if(confirm(translations.alertConfirmDeleteSubType[currentLanguage]))try{const a=await fetch(`${SHEETDB_API_URL}/id/${t}?sheet=${SHEETS.subscriptionTypes}`,{method:"DELETE"});if(!a.ok)throw new Error("Failed to delete subscription type.");subscriptionTypes=subscriptionTypes.filter(a=>a.id!==t),loadSubscriptionsPage()}catch(t){console.error(t),alert("An error occurred while deleting the subscription type.")}}
    function populateAddMemberModal(){const t=document.getElementById("add-member-subscription-type");t.innerHTML=`<option value="">-- ${translations.selectPlaceholder[currentLanguage]} --</option>`,subscriptionTypes.forEach(a=>{t.innerHTML+=`<option value="${a.id}">${a.name[currentLanguage]}</option>`}),document.getElementById("add-member-subscription-price").value=""}
    function populateSubscriptionModal(){const t=document.getElementById("subscription-modal-type");t.innerHTML=`<option value="" disabled selected>-- ${translations.selectPlaceholder[currentLanguage]} --</option>`,subscriptionTypes.forEach(a=>{t.innerHTML+=`<option value="${a.id}">${a.name[currentLanguage]}</option>`})}
    function formatCurrency(t){return`₪${Number(t).toFixed(2)}`}
    function loadReportsPage(){renderMemberGrowthChart(),renderSubscriptionsReportTable()}
    function renderMemberGrowthChart(){if("undefined"==typeof Chart)return;const t=document.getElementById("memberGrowthChart").getContext("2d"),a=members.reduce((t,a)=>{const o=new Date(a.createdAt).toLocaleString("en-US",{month:"short",year:"numeric"});return t[o]=(t[o]||0)+1,t},{}),o=Object.keys(a).sort((t,a)=>new Date(t)-new Date(a));let e=0;const r=o.map(t=>e+=a[t]);memberGrowthChart&&memberGrowthChart.destroy(),memberGrowthChart=new Chart(t,{type:"line",data:{labels:o,datasets:[{label:"Total Members",data:r,borderColor:"#0d6efd",backgroundColor:"rgba(13, 110, 253, 0.1)",fill:!0,tension:.3}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,grid:{color:"#3b3e47"},ticks:{color:"#f8f9fa"}},x:{grid:{color:"transparent"},ticks:{color:"#f8f9fa"}}}}})}
    function renderSubscriptionsReportTable(){const t=document.getElementById("subscriptions-report-table").querySelector("tbody");if(t.innerHTML="",0===members.filter(t=>t.subscription).length)return void(t.innerHTML=`<tr><td colspan="5" class="text-center py-4" data-translate="noSubData">${translations.noSubData[currentLanguage]}</td></tr>`);const a=new Date;a.setHours(0,0,0,0),members.filter(t=>t.subscription).forEach(o=>{let e,r;const n=new Date(o.subscription.endDate),s=Math.ceil((n-a)/864e5);!o.subscription.active||s<0?(e="Expired",r="danger"):s<=EXPIRATION_REMINDER_DAYS?(e="Expiring",r="warning"):(e="Active",r="success");const i=t.insertRow();i.innerHTML=`<td>${o.firstName} ${o.lastName}</td><td class="text-capitalize">${o.subscription.type}</td><td>${(new Date(o.subscription.startDate)).toLocaleDateString()}</td><td>${n.toLocaleDateString()}</td><td><span class="badge bg-${r}">${e}</span></td>`})}
    function loadMessagingPage(){const t=document.getElementById("individual-member");t.innerHTML=`<option value="" disabled selected>${translations.selectPlaceholder[currentLanguage]}</option>`,members.sort((t,a)=>t.firstName.localeCompare(a.firstName)).forEach(a=>t.innerHTML+=`<option value="${a.id}">${a.firstName} ${a.lastName}</option>`),renderMessageHistory()}
    function renderMessageHistory(){const t=document.getElementById("message-history-table").querySelector("tbody");if(t.innerHTML="",0===messageHistory.length)return void(t.innerHTML=`<tr><td colspan="4" class="text-center py-4" data-translate="noMessages">${translations.noMessages[currentLanguage]}</td></tr>`);messageHistory.sort((t,a)=>new Date(a.sentAt)-new Date(t.sentAt)).forEach(a=>{const o=t.insertRow();o.innerHTML=`<td>${(new Date(a.sentAt)).toLocaleDateString()}</td><td>${a.recipients}</td><td class="text-truncate" style="max-width: 250px;">${a.message}</td><td><span class="badge bg-success">${a.status}</span></td>`})}
    async function sendMessage(){const t=document.getElementById("message-recipients").value,a=document.getElementById("message-content").value.trim();let o=document.querySelector(`#message-recipients option[value="${t}"]`).textContent;if(!a)return alert(translations.alertEmptyMessage[currentLanguage]);let e=[];const r=new Date;r.setHours(0,0,0,0);const n=new Date;switch(n.setDate(r.getDate()+EXPIRATION_REMINDER_DAYS),t){case"all":e=[...members];break;case"active":e=members.filter(t=>t.subscription&&t.subscription.active);break;case"expiring":e=members.filter(t=>t.subscription?.active&&new Date(t.subscription.endDate)>=r&&new Date(t.subscription.endDate)<=n);break;case"male":e=members.filter(t=>"male"===t.gender);break;case"female":e=members.filter(t=>"female"===t.gender);break;case"individual":const t=document.getElementById("individual-member").value;if(!t)return alert(translations.alertSelectIndividual[currentLanguage]);const a=members.find(a=>a.id==t);a&&(e.push(a),o=`${a.firstName} ${a.lastName}`)}const s=e.map(t=>t.phone).filter(t=>t);if(0===s.length)return alert(translations.alertNoValidPhones[currentLanguage]);if(await sendSmsViaApi(s,a)){const t={sentAt:(new Date).toISOString(),recipients:o,message:a,status:"Sent"};try{await fetch(`${SHEETDB_API_URL}?sheet=${SHEETS.messageHistory}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:[t]})}),messageHistory.unshift(parseMessage(t)),alert(translations.alertMessageSentTo(o)),document.getElementById("message-form").reset(),document.getElementById("individual-select-container").classList.add("d-none"),renderMessageHistory()}catch(t){alert(translations.alertSmsApiFailure[currentLanguage])}}else alert(translations.alertSmsApiFailure[currentLanguage])}
    async function sendSmsViaApi(t,a){return console.log("%c--- SIMULATING SMS API CALL ---","color: #0d6efd; font-weight: bold; font-size: 1.1em;"),console.log("Sender: +972567342330"),console.log(`Recipients (${t.length}):`,t),console.log("Message:",a),console.log("Note: In a real app, this data would be sent via a secure POST request to an SMS provider's API endpoint."),new Promise(t=>{setTimeout(()=>{console.log("%c--- SIMULATION COMPLETE: SMS assumed to be sent. ---","color: #198754; font-weight: bold;"),t(!0)},1500)})}
    function downloadDataAsJSON(){const t={version:"11.0",exportedAt:(new Date).toISOString(),data:{members,messageHistory,subscriptionTypes,transactions,passwords}};const a=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),o=URL.createObjectURL(a),e=document.createElement("a");e.href=o,e.download=`vorta-fitness-data-${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(o)}
    async function importDataFromJSON(event){alert("Data import is a complex operation in database mode and is disabled to prevent accidental data corruption. Please add data manually or edit the Google Sheet directly.");event.target.value = '';}

</script>
</body>
</html>
